@{
    ViewBag.Title = "Watcher";
}

<h1>Movies</h1>
<script src="~/Scripts/bootstrap.min.js"></script>
<div class="row">
    <div class="col-md-8">
        <input type="text" class="form-control" id="search" placeholder="Search..">
        <div style="margin-top: 10px; margin-bottom: 10px;">
            <ul id="searchList" data-bind="foreach: searchResults">
                <li>
                    <a href="javascript:void(0)" data-bind="text: name, attr: { id: id }, value: poster"> </a>
                </li>
            </ul>
        </div>
        
        <h2>Upcoming</h2>
        <div style="margin-top: 10px; margin-bottom: 10px;">
            <ul id="upcoming" data-bind="foreach: upcoming">
                <li>
                    <a href="javascript:void(0)" data-bind="text: name, attr: { id: id }, value: poster"> </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<p id="succesMessage" class="bg-success hidden" style="height: 35px; line-height: 35px; padding-left: 10px;">Success!</p>

<div class="modal fade" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Subscribe</h4>
            </div>
            <div class="modal-body">
                <p id="movieId" class="hidden"></p>
                <p id="movieName" class="hidden"></p>
                <p id="modal-content" style="text-align: center;"></p>
                <div id="poster-image"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="subscribe">Subscribe!</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        var viewModel = new ViewModel();
        ko.applyBindings(viewModel);

        var prefix = null;

        function ViewModel() {
            var self = this;

            self.upcoming = ko.observable();
            self.searchResults = ko.observable();

            $.ajax({
                dataType: "json",
                type: 'POST',
                url: '@Url.Action("Upcoming", "Movies")',
                success: upcoming
            });

            function upcoming(data) {
                prefix = data.PrefixPath;
                data = data.Movies;

                var movies = new Array();

                for (var i = 0; i < data.length; i++) {
                    movies.push(new Movie(data[i].Id, data[i].Name, data[i].PosterPath));
                }

                self.upcoming(movies);
            }

            self.search = $('#search').on('input', function() {
                if ($('#search').val().length > 0) {
                    $.ajax({
                        dataType: "json",
                        type: 'POST',
                        url: '@Url.Action("Search", "Movies")',
                    data: {
                        input: $('#search').val()
                    },
                    success: displaySearchResults
                });
}
            });

            function displaySearchResults(data) {
                prefix = data.PrefixPath;
                data = data.Movies;

                var movies = new Array();

                for (var i = 0; i < data.length; i++) {
                    movies.push(new Movie(data[i].Id, data[i].Name, data[i].PosterPath));
                }

                self.searchResults(movies);
            }
        }

        function Movie(id, name, posterPath) {
            var self = this;

            self.id = ko.observable(id);
            self.name = ko.observable(name);
            self.poster = ko.observable(posterPath);
        }

        $('#subscribe').click(function () {
            $.ajax({
                dataType: "json",
                type: 'POST',
                url: '@Url.Action("Subscribe", "Movies")',
                data: {
                    id: $('#movieId').text(),
                    name: $('#movieName').text()
                },
                success: function(success) {
                    if (success) {
                        $('#myModal').modal('hide');
                        $('#succesMessage').removeClass('hidden');
                    }
                }
            });
        });

        $('#upcoming').on('click', 'a', function () {
            displayInfo(this.id, this.text, this.value);
        });

        $('#searchList').on('click', 'a', function () {
            displayInfo(this.id, this.text, this.value);
        });

        function displayInfo(id, name, poster) {
            $('#succesMessage').addClass('hidden');
            $('#modal-content').text('Subscribe to: ' + name);

            $('#movieId').text(id);
            $('#movieName').text(name);

            $('#poster-image').removeAttr('style');
            if (prefix != poster && poster) {
                $('#poster-image')
                    .css('background-image', 'url(' + prefix + poster + ')')
                    .css('height', '19em').css('width', '13em')
                    .css('margin', '0 auto');
            }
            
            $('#myModal').modal('show');
        }
    });
</script>